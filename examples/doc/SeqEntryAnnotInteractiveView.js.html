<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: views/SeqEntryAnnotInteractiveView.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: views/SeqEntryAnnotInteractiveView.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>define(
    /**
     @exports SeqEntryAnnotInteractiveView
     @author Alexandre Masselot
     @author Kiran Mukhyala
     @copyright 2013,  Bioinformatics & Computational Biology Department, Genentech Inc.
     */

    ['jquery', 'underscore', 'backbone', 'd3', 'pviz/services/FeatureManager', './FeatureDisplayer', './SeqEntryViewport', 'pviz/models/FeatureLayer', './FeatureLayerView', './HiddenLayersView', './DetailsPane', 'text!pviz_templates/seq-entry-annot-interactive.html'],
    function ($, _, Backbone, d3, featureManager, featureDisplayer, SeqEntryViewport, FeatureLayer, FeatureLayerView, HiddenLayersView, DetailsPane, tmpl) {
        /**
         * @class SeqEntryAnnotInteractiveView is the main interactive viewer for one SeqEntry
         * @constructor
         * @param {Map} options
         * @param {Number} options.marginLeft inner margin (default=20)
         * @param {Number} options.marginRight (default=20)
         * @param {Number} options.marginTop (default=25)
         * @param {Number} options.paddingCategory padding between categories (default=0)
         * @param {Function} options.xChangeCallback callback called whenever the x refence is changed (zooming)
         * @param {Boolean} options.noPositionBubble
         * @param {Boolean} options.hideAxis hide the position axis (default=false)
         * @param {Boolean} options.hideSequence hide the sequence (defaut=false)
         * @param {Array} options.categoryOrder an array of String specifying the order in which should appear the categories (unspecified one will appear alpha numerically sorted)
         * @param {String} options.layerMenu specify what type of menu is to be set on each category FeatureLayerView (default=sticky)
         * @augments Backbone.View
         */
        var SeqEntryAnnotInteractiveView = Backbone.View.extend(/** @lends module:SeqEntryAnnotInteractiveView~SeqEntryAnnotInteractiveView.prototype */{

            initialize: function (options) {
                var self = this;
                self.options = options;

                self.margins = {
                    left: options.marginLeft || 20,
                    right: options.marginRight || 20,
                    top: options.marginTop || 25
                };
                self.layers = [];
                self.layerViews = [];
                self.hide = {};

                self.paddingCategory = options.paddingCategory || 0;

                self.bubbleSequenceNb = 4;
                self.clipperId = 'clipper_' + Math.round(100000 * Math.random());

                $(self.el).empty();
                var el = $(tmpl);
                $(self.el).append(el)

                self.components = {
                    features: el.find('#feature-viewer'),
                    details: el.find('#details-viewer')
                }

                self.svg = d3.select(self.components.features[0]).append("svg").attr("width", '100%').attr("height", '123').attr('class', 'pviz');
                self.p_setup_defs();

                var rectBg = self.svg.insert("rect").attr("class", 'background').attr('width', '100%').attr('height', '100%');

                var xChangeCallbacks = [];
                if (options.xChangeCallback) {
                    xChangeCallbacks.push(options.xChangeCallback);
                }

                /*
                 * add the callback to set the aabubble position and text (if needed)
                 */
                if (!options.noPositionBubble) {
                    xChangeCallbacks.push(function (i0, i1) {
                        var gbubbles = self.svg.selectAll('g.axis-bubble');
                        if (self.viewport.scales.font > 10) {
                            gbubbles.style('display', 'none');
                            self.svg.select('line.sequence-bg').style('display', 'none');
                            return
                        }
                        self.svg.select('line.sequence-bg').style('display', null);

                        var imid = (i0 + i1) / 2;
                        var xscales = self.viewport.scales.x;
                        if (imid &lt; xscales.domain()[0] || imid > xscales.domain()[1]) {
                            gbubbles.style('display', 'none');
                            return;

                        }
                        gbubbles.style('display', null);
                        if (self.gPosBubble) {
                            self.gPosBubble.selectAll('text').text(Math.round(imid + 1));
                        }

                        if (self.gAABubble) {
                            var ic0 = Math.round(imid) - self.bubbleSequenceNb;
                            var ic1 = Math.round(imid) + self.bubbleSequenceNb;
                            var subseq = self.model.get('sequence').substring(ic0, ic1 + 1);

                            var ts = self.gAABubble.selectAll('text.subseq').data(subseq.split(''));
                            ts.exit().remove();
                            ts.enter().append("text").attr('class', 'subseq');
                            ts.text(function (d) {
                                return d;
                            }).attr('x', function (t, i) {
                                var d = Math.abs(i - 4);
                                return (i - self.bubbleSequenceNb) * 10 / (1 + d * 0.1)
                            }).style('font-size', function (t, i) {
                                var d = Math.abs(i - 4);
                                return '' + (120 * (0.2 + 0.2 * (4 - d))) + '%';
                            }).attr('y', -3);
                        }

                        //                  gbubble.selectAll('text.subseq').data(subseq.split(''));
                        gbubbles.attr('transform', 'translate(' + xscales(imid) + ',10)');
                    });

                }
                self.viewport = new SeqEntryViewport({
                    el: self.components.features,
                    svg: self.svg,
                    length: self.model.length(),
                    margins: self.margins,
                    changeCallback: function (vp) {
                        self.p_positionText(vp, self.svg.selectAll('text.data'));
                        featureDisplayer.position(vp, self.svg.selectAll('g.data'));

                        if (!options.hideAxis)
                            self.updateAxis();
                        // self.p_positionText(vp, self.svg.selectAll('text.data').transition()).duration(1);
                        // featureDisplayer.position(vp, self.svg.selectAll('g.data').transition()).duration(1);
                    },
                    xChangeCallback: xChangeCallbacks
                });

                self.drawContainer = self.svg.append('g');
                //.attr('transform', 'translate(' + self.margins.left + ',' + self.margins.top + ')');
                self.axisContainer = self.drawContainer.append('g').attr('class', 'axis')
                //var yshiftScale = options.hideAxis ? 0 : 20;

                self.layerContainer = self.drawContainer.append('g').attr('class', 'layers');

                self.detailsPane = new DetailsPane({
                    el: self.components.details
                })

                self.update()
                if (!options.hideAxis)
                    self.updateAxis();

                self.listenTo(self.model, 'change', self.update)

            },
            /**
             * @private
             */
            updateAxis: function () {
                var self = this;

                var vpXScale = self.viewport.scales.x;
                var scale = d3.scale.linear().domain([vpXScale.domain()[0] + 1, vpXScale.domain()[1] + 1]).range(vpXScale.range());
                var xAxis = d3.svg.axis().scale(scale).tickSize(6, 5, 5).tickFormat(function (p) {
                    return (p == 0) ? '' : p
                }).ticks(4);
                self.axisContainer.call(xAxis);
                self.gPosBubble = self.axisContainer.append('g').attr('class', 'axis-bubble').style('display', 'none');
                self.gPosBubble.append('rect').attr('x', -30).attr('y', -4).attr('width', 60).attr('height', 17)
                self.gPosBubble.append('text').attr('class', 'pos').attr('y', 6);

            },
            /**
             * refresh the whole view
             */
            update: function () {
                var self = this;
                self.layerContainer.selectAll('g').remove()
                self.svg.select('g.groupset-title').remove()

                self.layers = [];
                self.layerViews = [];
                if (!self.options.hideSequence) {
                    self.p_setup_layer_sequence();
                }

                self.p_setup_layer_features();
                self.p_setup_hidden_layers_container();
                self.p_setup_groupset_titles()
                self.render()

                _.each(self.layers, function (layer) {
                    layer.on('change', function () {
                        self.render();
                    })
                });
            },
            /**
             * render: show the visible layers and pile them up.
             */
            render: function () {
                var self = this;

                var totTracks = 0;
                var totHeight = 0

                var previousGroupSet = undefined;
                _.chain(self.layerViews).filter(function (layerViews) {
                    return true;
                }).each(function (view) {
                    if (view.model.get('visible')) {
                        var currentGroupSet = view.model.get('groupSet');
                        if (currentGroupSet != previousGroupSet) {
                            var cgsId = (currentGroupSet || '').replace(/\W/g, '_');
                            totTracks += 2
                            previousGroupSet = currentGroupSet;
                            var yshiftScale = self.options.hideAxis ? -20 : 0;
                            self.gGroupSets.select('text#groupset-title-' + cgsId).attr('y', self.viewport.scales.y(totTracks) + totHeight + yshiftScale)
                        }
                        var yshift = self.viewport.scales.y(totTracks + 1)
                        view.g.attr("transform", 'translate(' + 0 + ',' + yshift + ")");
                        if (view.model.get('isPlot')) {
                            totHeight += view.height();
                            totTracks += 1 + self.paddingCategory;
                        } else {
                            totTracks += view.height() + 1 + self.paddingCategory;
                        }
                        view.g.style('display', null);

                    } else {
                        view.g.style('display', 'none');
                    }
                });
                self.hiddenLayers.g.attr("transform", "translate(0," + (self.viewport.scales.y(totTracks + 1) + totHeight + 20) + ")");

                var heightAdd = 0;
                if (!self.options.hideAxis) {
                    heightAdd += 30;
                    self.axisY = self.viewport.scales.y(totTracks) + heightAdd + totHeight;
                    self.axisContainer.attr('transform', 'translate(0, ' + self.axisY + ')');
                }
                if (!self.options.hideSequene) {
                    heightAdd += 25;
                }

                self.svg.attr("height", self.viewport.scales.y(totTracks) + totHeight + heightAdd)
            },
            /**
             * define gradients to be used.
             * This should certainly lie elsewhere...
             * @private
             */
            p_setup_defs: function () {
                var self = this;
                var defs = self.svg.append('defs');

                var gr = defs.append('svg:linearGradient').attr('id', 'grad_endFTBlock').attr('x1', 0).attr('y1', 0).attr('x2', '100%').attr('y2', 0);
                gr.append('stop').attr('offset', '0%').style('stop-color', '#fff').style('stop-opacity', 0);
                gr.append('stop').attr('offset', '100%').style('stop-color', '#fff').style('stop-opacity', 0.3);

                var xRight = ($(self.el).width() || $(document).width()) - self.margins.right;
                defs.append('clipPath').attr('id', self.clipperId).append('path').attr('d', 'M' + (self.margins.left - 15) + ',-100L' + (xRight + 15) + ',-100L' + (xRight + 15) + ',20000L' + (self.margins.left - 15) + ',20000');
            },
            /**
             * build the Sequence layer
             * @private
             */
            p_setup_layer_sequence: function () {
                var self = this;

                var layer = new FeatureLayer({
                    name: 'sequence',
                    nbTracks: 2
                })
                self.layers.push(layer)
                var view = new FeatureLayerView({
                    model: layer,
                    container: self.layerContainer,
                    viewport: self.viewport,
                    cssClass: 'sequence',
                    noMenu: true,
                    margins: self.margins,
                    clipper: '#' + self.clipperId
                })
                self.layerViews.push(view)

                view.gFeatures.append('line').attr('x1', -100).attr('x2', 2000).attr('class', 'sequence-bg').attr('y1', 7).attr('y2', 7);
                var sel = view.gFeatures.selectAll("text").data(self.model.get('sequence').split('')).enter().append("text").attr('class', 'sequence data').text(function (d) {
                    return d;
                });

                self.p_positionText(self.viewport, sel);
                self.gAABubble = view.g.append('g').attr('class', 'axis-bubble').style('display', 'none');
                self.gAABubble.append('rect').attr('x', -30).attr('y', -12).attr('width', 61).attr('height', 16)
                self.gAABubble.append('text').attr('class', 'subseq').attr('y', 2);
            },
            /**
             * group features by category, and build a layer for each of them
             * @private
             */
            p_setup_layer_features: function () {
                var self = this;

                var groupedFeatures = _.groupBy(self.model.get('features'), function (ft) {
                    var gcid = (ft.groupSet ? (ft.groupSet + '/') : ' /') + ft.category;
                    ft._groupCatId = gcid;
                    return gcid;

                });

                //it is possible to pass the category Order, thus sort on it at first
                var buildOrder=function(orderName){
                    var order;
                    if (self.options[orderName] !== undefined) {
                        order = {};
                        _.each(self.options[orderName], function (n, i) {
                            order[n] = i + 1;
                        });
                        return order;
                    }
                    return undefined;
                };
                var categoryOrder = buildOrder('categoryOrder');
                var groupSetOrder = buildOrder('groupSetOrder');


                _.chain(groupedFeatures)
                    .sortBy(function (group) {
                        if (categoryOrder !== undefined) {
                            return 1000000 * (categoryOrder[group[0].category] || 100);
                        }

                        if(groupSetOrder){
                            return 1000000 * (groupSetOrder[group[0].groupSet] || 100);

                        }
                        if (!group[0].groupSet) {
                            return -99999;
                        }

                        return group[0].groupSet;
                    })
                    .each(function (group, groupConcatName) {
                        var nbTracks, isPlot;
                        if (featureDisplayer.isCategoryPlot(group[0].category)) {
                            nbTracks = 1;
                            isPlot = true;
                        } else {
                            nbTracks = featureManager.assignTracks(group);
                        }
                        var groupName = group[0].category;
                        var groupType = group[0].categoryType || groupName;
                        var groupSet = group[0].groupSet;
                        var cssClass = groupName.replace(/\s+/g, '_')

                        var layer = new FeatureLayer({
                            name: (group[0].categoryName === undefined) ? groupName : group[0].categoryName,
                            type: groupType,
                            category: groupName,
                            groupSet: groupSet,
                            id: 'features-' + cssClass,
                            nbTracks: nbTracks,
                            isPlot: isPlot
                        });
                        self.layers.push(layer)

                        var layerView = new FeatureLayerView({
                            model: layer,
                            container: self.layerContainer,
                            viewport: self.viewport,
                            cssClass: cssClass,
                            layerMenu: self.options.layerMenu,
                            margins: self.margins,
                            clipper: '#' + self.clipperId
                        });
                        self.layerViews.push(layerView);

                        var sel;
                        if (isPlot) {
                            sel = featureDisplayer.categoryPlotAppend(groupName, self.viewport, layerView.gFeatures, group).classed(cssClass, true);
                        } else {
                            sel = featureDisplayer.append(self.viewport, layerView.gFeatures, group).classed(cssClass, true);

                        }
                        //add tolltip based on description field
                        sel.append('title').text(function (ft) {
                            return ft.description;
                        });
                    });

            },
            /**
             * @private
             */
            p_setup_hidden_layers_container: function () {
                var self = this;

                self.hiddenLayers = new HiddenLayersView({

                    container: self.svg,
                    layers: self.layers,
                    nbTracks: 1
                });
                // /self.layers.push(layer)

            },
            /**
             * @private
             * @return {SeqEntryAnnotInteractiveView}
             */
            p_setup_groupset_titles: function () {
                var self = this;
                var groupSetNames = _.chain(self.model.get('features')).map(function (ft) {
                    return ft.groupSet
                }).unique().filter(function (t) {
                    return t
                }).value();

                self.gGroupSets = self.svg.append('g').attr('class', 'groupset-title');
                self.gGroupSets.selectAll('text').data(groupSetNames).enter().append('text').text(function (x) {
                    return x;
                }).attr('x', 7).attr('y', 10).attr('id', function (x) {
                    return 'groupset-title-' + (x || '').replace(/\W/g, '_');
                })

                return self;
            },
            /**
             * position sequence text.
             * @param {Object} viewport
             * @param {Object} sel
             * @private
             */
            p_positionText: function (viewport, sel) {
                var self = this;
                sel.attr('x', function (d, i) {
                    return viewport.scales.x(i);
                }).attr('y', viewport.scales.y(1) - 7).style('font-size', '' + viewport.scales.font + 'px').style('letter-spacing', '' + (viewport.scales.x(2) - viewport.scales.x(1) - viewport.scales.font) + 'px')
                return sel
            }
        });

        return SeqEntryAnnotInteractiveView;
    })</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-DASReader.html">DASReader</a></li><li><a href="module-DetailsPane.html">DetailsPane</a></li><li><a href="module-FastaReader.html">FastaReader</a></li><li><a href="module-FeatureDisplayer.html">FeatureDisplayer</a></li><li><a href="module-FeatureLayer.html">FeatureLayer</a></li><li><a href="module-FeatureLayerCollection.html">FeatureLayerCollection</a></li><li><a href="module-FeatureLayerView.html">FeatureLayerView</a></li><li><a href="module-FeatureManager.html">FeatureManager</a></li><li><a href="module-GGPLot2Adapter.html">GGPLot2Adapter</a></li><li><a href="module-HiddenLayersView.html">HiddenLayersView</a></li><li><a href="module-OneLiner.html">OneLiner</a></li><li><a href="module-PositionedFeature.html">PositionedFeature</a></li><li><a href="module-SeqEntry.html">SeqEntry</a></li><li><a href="module-SeqEntryAnnotInteractiveView.html">SeqEntryAnnotInteractiveView</a></li><li><a href="module-SeqEntryFastaView.html">SeqEntryFastaView</a></li><li><a href="module-SeqEntryTableView.html">SeqEntryTableView</a></li><li><a href="module-SeqEntryViewport.html">SeqEntryViewport</a></li><li><a href="module-TypeDisplayer.html">TypeDisplayer</a></li></ul><h3>Classes</h3><ul><li><a href="module-DASReader-DASReader.html">DASReader</a></li><li><a href="module-DetailsPane-DetailsPane.html">DetailsPane</a></li><li><a href="module-FastaReader-FastaReader.html">FastaReader</a></li><li><a href="module-FeatureDisplayer-FeatureDisplayer.html">FeatureDisplayer</a></li><li><a href="module-FeatureLayerCollection-FeatureLayerCollection.html">FeatureLayerCollection</a></li><li><a href="module-FeatureLayerView-FeatureLayerView.html">FeatureLayerView</a></li><li><a href="module-FeatureLayer-FeatureLayer.html">FeatureLayer</a></li><li><a href="module-FeatureManager-FeatureManager.html">FeatureManager</a></li><li><a href="module-HiddenLayersView-HiddenLayersView.html">HiddenLayersView</a></li><li><a href="module-OneLiner-OneLiner.html">OneLiner</a></li><li><a href="module-PositionedFeature-PositionedFeature.html">PositionedFeature</a></li><li><a href="module-SeqEntryAnnotInteractiveView-SeqEntryAnnotInteractiveView.html">SeqEntryAnnotInteractiveView</a></li><li><a href="module-SeqEntryFastaView-SeqEntryFastaView.html">SeqEntryFastaView</a></li><li><a href="module-SeqEntryTableView-SeqEntryTableView.html">SeqEntryTableView</a></li><li><a href="module-SeqEntryViewport-SeqEntryViewport.html">SeqEntryViewport</a></li><li><a href="module-SeqEntry-SeqEntry.html">SeqEntry</a></li><li><a href="module-TypeDisplayer-TypeDisplayer.html">TypeDisplayer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#discrete_palettes">discrete_palettes</a></li><li><a href="global.html#shapePaths">shapePaths</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Tue Apr 07 2015 19:50:25 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
